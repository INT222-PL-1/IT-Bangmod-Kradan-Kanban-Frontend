name: Build and Push docker image
run-name: "@${{ github.actor }} was pushed up a new update. Auto-Redeploy START!"
on: 
  push:
    branches:
    - 'main'
    - 'develop/**'
  
jobs:     
    Prepare-to-docker-image-build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        - name: Create .env file & set up node
          run: |
            echo "${{ secrets.ENV_PRODUCTION_FILE }}" > .env.production
            ls -a
        - uses: actions/setup-node@v4
          with:
            node-version: 20
        - name: Cache node modules
          id: cache-npm
          uses: actions/cache@v4
          env:
            cache-name: cache-node-modules
          with:
            # npm cache files are stored in `~/.npm` on Linux/macOS
            path: ~/.npm
            key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
            restore-keys: |
              ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
              ${{ runner.os }}-build-
              ${{ runner.os }}-
  
        - name: Install Dependencies
          if: steps.cache.outputs.cache-hit != 'true'
          run: /install.sh
      
              
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
        - name: Build and push
          uses: docker/build-push-action@v5
          with:
            context: .
            file: ./Dockerfile
            push: true
            tags: wanassanan/itb-kk-frontend:latest
            cache-from: type=gha
            cache-to: type=gha,mode=max

    SSH-Remote-Deploy:
      needs:  Prepare-to-docker-image-build
      runs-on: ubuntu-latest
      steps:
      - name: executing remote ssh commands using password
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            docker pull wanassanan/itb-kk-frontend:latest
            docker compose -f ./INT221/project/docker-compose.yml up -d --no-deps --build frontend
